# Scenario

## 登場人物・記号説明

- ず: ずんだもん
- め: めたん
- テ: テキスト表示
- SE: 効果音
- BGM: 背景音楽
- ア: アニメーション
- 画: 画像関連

## ページ送りの単位

- 1クリックでずんだもんかめたんのセリフが1つ進む
- 他の要素は次のセリフまでまとめて実行

## 基本機能

- セーブ
  - セーブボタンを押すことでセーブ画面を表示
  - セーブ画面ではスロットを選択してセーブ可能
  - すでにセーブされているスロットを選択した場合は、確認を取って上書き保存
  - セーブデータにはセーブ日時と、現在表示されているテキストの一部を表示
  - 戻る画面を押すことで一つ前の画面へ戻る
- ロード
  - ロードボタンを押すことでロード画面を表示
  - セーブされているスロットを選択してロードし、ゲームを再開できる
  - 戻る画面を押すことで一つ前の画面へ戻る
- スキップ
  - スキップボタンを押すことでスキップモードに移行
  - スキップモード中はクリックでテキストが高速で進む
  - 再度スキップボタンを押すか、セリフ表示中にクリックすることでスキップモードを解除
- ログ表示
  - ログボタンを押すことで会話ログ画面を表示
  - 会話ログ画面では過去のセリフをさかのぼって閲覧可能（最大50件まで）
  - 戻る画面を押すことで一つ前の画面へ戻る
- 設定変更
  - 設定ボタンを押すことで設定画面を表示
  - 設定項目
    - BGM音量調整
    - SE音量調整
    - テキスト表示速度調整
  - 戻る画面を押すことで一つ前の画面へ戻る
  - ここで管理する設定項目はローカルストレージに保存
  - ゲームを開始する際、ローカルストレージにある設定をuseElementのinit関数からmessageを通じてModelに反映する

## UI共通仕様

- ずんだもんとめたんについては立ち絵を使用すること
  - [ずんだもん](/examples/tutorial/src/assets/images/zundamon/)
  - [めたん](/examples/tutorial/src/assets/images/metan/)
  - 各表情を用意しているため、シナリオに応じて適切な表情を選択して使用すること

## イントロ

- 各キャラクターのボイスあり
  - 各キャラ001番からセリフに合わせて順番に使用すること
  - 015_metan.mp3 および 023_zundamon.mp3 はこの章では使用しない
- キャラクターのセリフはキャラクターに対して吹き出し形式で表示
  - キャラクターのセリフのみ表示
- 画面右下にセーブボタン、ロードボタン、スキップボタン、ログボタン、設定ボタンをアイコンで表示
  - ボタンは半透明で、ホバー時に不透明になる

### 本文

- 画: おうちのリビングを背景画像として表示
- BGM: 暴竜ニードルード
- SE: 爆発1
- SE: 刀の素振り2（ループ再生）
- ア: ずんだもん反復横跳び
- ず: うおーーーーーー！！！
- ず: ノベルゲームが、作りたいのだ！！！
- め: はぁ……いつにもましてうるさいですね。今日はどうしたんですか？
- SE: 反復横跳びループ停止
- ア: ずんだもん反復横跳び停止
- ず: めたん、聞いてほしいのだ！
- ず: ノベルゲームが作りたいのだ！
- め: ノベルゲーム？　なんでまたノベルゲームなの？　ゲームならRPGとかアクションとか、ほかにも色々あるでしょ。
- ず: よくぞ聞いてくれのだ！
- BGM: 暴竜ニードルード 一時停止
- BGM: 平氏
- ず: めたん。ノベルゲームとは、芸術なのだ。
- め: なんか始まったぞおい。
- ず: これは単なるゲームではない。言葉と、音と、イラストが紡ぎだす総合芸術なのだ。
- ず: かの萩原朔太郎も、人の感情を完全に表現しようと思ったら、そこには音楽と詩があるばかりと言ったのだ。
- ず: そう、何かを表現しようと思ったら、そこには言葉を超えた言葉と、音を超えた音が必要なのだ。
- ず: でもノベルゲームはそれだけではない！　なんとイラストも使えてしまうのだ！
- ず: これだけ表現の幅があるなら、きっとすごいものが作れるに違いないのだ！
- BGM: 平氏フェードアウト
- BGM: 暴竜ニードルード 再開
- ず: なぁめたんもそう思うのだ？
- め: まぁおおむね同意するけど……じゃあずんだもんは小説とか詩とか書いたことあるの？
- SE: 和太鼓でドン
- ず: ない！
- め: 音楽は？
- SE: 和太鼓でドン
- ず: ない！！
- め: イラストは？
- SE: 和太鼓でドドン
- ず: ないのだ！！！
- め: プログラミングは？
- SE: 荘厳な雰囲気
- ず: それはできるのだ！！！！！
- め: はぁ。左様ですか……。
- ず: というわけでめたん、次合うまでに神ゲーを作ってくるから、それまで首洗って待っておくのだ！
- SE: ピューンと逃げる
- ア: ずんだもん画面外へ退場
- ず: じゃあな！
- BGM: フェードアウト
- め: あぁ行っちゃった……まぁきっと途中で飽きちゃうでしょうねぇ……。
- （フェードアウト）
- SE: ニワトリの鳴き声
- テ: 2週間後……
- （フェードイン）
- BGM: 進軍
- ず: やぁめたん。
- め: あら久しぶりねずんだもん。って何そのサングラス。
- ず: できたのだ。
- め: 何が？
- SE: 紙を広げる1
- 画: ソースコード
- ア: ソースコードをフェードイン
- め: えなにこれ。
- ず: ソースコードなのだ。
- め: いやわかるけど。なんの？
- ず: ゲーム『エンジン』の、ソースコードなのだ。
- め: ……はい？
- BGM: 進軍停止
- ア: ゲーム画面をいきなり暗転
- SE: 男衆「イヤッホー！」
- テ: 関数型ノベルゲームエンジン "tsuzuri" 解説
- （クリック待機）
- ア: ゲーム画面フェードアウト

## tsuzuriとは

- キャラクターのセリフはテキストボックスに表示
  - キャラクター名
  - キャラクターのセリフ
- テキストボックス右下にセーブボタン、ロードボタン、スキップボタン、ログボタン、設定ボタンをアイコンで表示
  - ボタンは半透明で、ホバー時に不透明になる

### 本文

- BGM: 解説曲
- ア: ゲーム画面フェードイン
- ず: このノベルゲームエンジンを、僕は "tsuzuri" と呼んでいるのだ。
- 画: Elm言語のロゴ
- 画: Elm Architectureの図
- ア: Elm関連の画像フェードイン
- ず: tsuzuriは関数型プログラミング、特にElm Architectureという、Elm言語が提唱するソフトウェアアーキテクチャを強く意識して開発しているのだ。
- ず: tsuzuriではノベルゲームを実現するうえで必要なModelと呼ばれる状態と、Messageと呼ばれるゲームのイベントのようなもの。
- ず: あと、Message発火時にModelの更新を担うUpdate関数をゲームエンジンから提供しているのだ。
- ず: 実装者はMessageを組み合わせて使うことで、自由にノベルゲームを制作することができるのだ。
- 画: Elm関連の画像削除
- め: ちょっと待ってずんだもん。
- ず: どうしたのだ？
- め: さっぱりわからないわ。
- め: 申し訳ないのだけれど、関数型プログラミングとか、Elm Architectureとか、あまりなじみがないわ。
- ず: 大丈夫！　要はこういうことなのだ！
- ず: まず一番重要なこととして頭に入れて欲しいのは、tsuzuriではノベルゲームを『発行したMessageの集積結果』と捉えていることなのだ。
- 画: ゲーム画面の例1
- ア: ゲーム画面の例1フェードイン
- ず: 例えばこういったゲーム画面があったとするのだ。
- ず: 今画面にはキャラクターがいて、背景があって、テキストボックスがあって、BGMが流れているのだ。
- ず: この状態から、ユーザーが画面をクリックしたとするのだ。
- 画: ゲーム画面の例1を削除、ゲーム画面の例2をフェードイン
- ず: すると、テキストボックスの中身が変わったのだ。
- ず: tsuzuriではこれを、ユーザーのクリックというアクションによって、『テキストを進めるMessageが発行された』と考えるのだ。
- 画: ゲーム画面の例2を削除
- 画: Elm Architectureの図再表示
- ず: このMessageが発行されると、ゲームの裏側にあるModelのうち、UIの表示に関する情報をUpdate関数が更新して、そのModelの変更に基づいてUIも更新されるのだ。
- ず: ほかの要素についても同じなのだ。キャラの立ち絵を変更するのもUI変化だし、BGMやSEを流すのは、音声操作のMessageによる状態変化と捉えられるのだ。
- ず: こう考えることで、いま目の前にあるゲームの状態は、過去に発行された大量のMessageの積み重ねによってできた結果と捉えることができるのだ！
- め: ……つまり、ノベルゲームを動かすのに必要なパラメータとしてのModelと、ノベルゲームで起こりうるイベントとしてのMessageさえわかってしまえば、ゲームエンジンは作れてしまうと。
- め: そしてゲームエンジンの利用者は、自分でMessageを組み合わせてゲームエンジンに与えてあげれば、その通りに動くゲームが作れる、ということかしら？
- ず: ほぼその理解であっているのだ！
- ず: とにかくMessageを投げてModelを更新、この連続でゲームを構築できるというのが、tsuzuriのコンセプトになっているのだ！
- 画: Elm Architectureの図削除
- め: でもどうしてこんな作りにしたの？　ゲーム開発は詳しくないけど、少なくともこうした設計がメジャーだとは思えないわ。
- ず: メリットがいくつかあるのだ。
- ず: 例えば、会話ログの構築が簡単になるのだ。
- 画: ゲーム画面の例3（会話ログ表示）
- ず: ノベルゲームでは、過去の会話ログをさかのぼって閲覧する機能がよくあるのだけれど、これは過去に発行したMessageから絞り込めば一瞬で作れるのだ！
- め: ノベルゲームの現在の状態は、過去のMessageを積み重ねた結果だから、発行されたMessageを保持していれば、昔の状態は復元可能、ってことかしら？
- ず: まさにその通りなのだ！
- ず: もちろん、文字通りすべてのMessageをゲームの最後まで保持し続けるのはさすがに厳しいのだ。
- ず: でもノベルゲームにおいて、本当の意味で常に保持しておかなければならない情報は、特殊なギミックがない限り、実はそんなに多くないのだ。
- め: まぁゲーム自体、基本はシンプルな作りですからねぇ。
- 画: ゲーム画面の例3削除
- ず: あとはセーブデータの管理がかなり楽なのだ。
- ず: tsuzuriにおいて、ゲームの状態は1つの大きなModelによって管理されているのだ。
- ず: つまり、このModelをどこかに保存するだけで、セーブのロジックはほぼ完成するのだ！
- ず: 「本当にそんなことできるの？」と思ったそこのキミ！　いい着眼点なのだ！
- め: まだ何も言ってないです。
- ず: 実は、ここにはElm Architectureの考えが大きく反映されているのだ。
- 画: Elm Architectureの図再表示
- ず: これまでModel、Message、Update関数は紹介したけど、Elm Architectureでは、ModelをUIに変換するView関数というのも存在するのだ。
- ず: Elm言語におけるView関数は、Modelを受け取ってUIっぽいものを返却するのだけど、この関数は参照透過性が保証されているのだ。
- め: さん……何？
- ず: 参照透過性なのだ！
- 画: Elm Architectureの図削除
- ず: 例えばめたん、f(x) = 2xという関数がある時に、f(2)を計算するとどうなるのだ？
- め: え、4だけど。
- ず: じゃあ今日の天気がくもりのときのf(2)は？
- め: いや4でしょ。
- SE: ひらめく2
- ず: 昨日めたんの体重が増えてショックだったときのf(2)は？
- SE: バイオリン恐怖音1
- ア: めたん振動
- め: 殴るわよ？
- ア: めたん静止
- ず: そう、計算結果は変わらないのだ。
- ず: 同じ引数を渡したときに、常に同じ計算結果が得られる。これが参照透過性なのだ。
- ず: そしてこの性質を、ゲームエンジン自体が持っているとしたらどうなるのだ？
- め: あっ……同じ状態を引数として与えれば、同じ進行状況を再現できる……？
- SE: クイズ正解5
- ず: ザッツコレクトなのだ！
- ず: Elm言語では、基本的にUIの再現のみしかサポートしていないのだ。
- ず: でもtsuzuriでは、Modelから実際の音声への変換もサポートしているから、BGMの再現も一発なのだ！
- ず: だからセーブではModelを保存するだけを考えればよいのだ！
- ず: まぁtsuzuriではセーブやロードの機能を提供しているから、利用者がセーブについて考える必要はほぼないのだけどね……。
- め: 至れり尽くせりね。
- め: ところで、ちょっと気になったことをいいかしら？
- め: tsuzuriでは状態の更新をMessageを通して行うのよね？　これってオブジェクト指向とかのメソッドで変数を書き換えるのと何が違うのかしら？
- ず: えぇ！　そんなことも聞いてくれるのだ！？
- め: 嬉しそうで何よりです。
- ず: ここもかなり大きなポイントなのだ。
- ず: 少し前にも言った通り、tsuzuriにおいてノベルゲームはMessageの集積なのだ。
- ず: Messageの集積ということは、もちろんシナリオもMessageで作れるのだ！
- 画: シナリオ管理のソースコードを表示
- め: なるほど、ゲームのシナリオを定数で管理できるというわけね。
- ず: tsuzuriのModelでは、今どのシナリオを参照しているかのエイリアスと、どこまでシナリオが進んでいるかを管理するインデックスを抱えているのだ。
- ず: 要はエイリアスで参照するシナリオを選んで、インデックスでその進行度を管理しているのだ。
- ず: 実装者の視点では、シナリオをMessageの配列で作って、そこに紐づくエイリアス名を用意しておけばOKなのだ。
- ず: あとはtsuzuriに向かって、参照させるシナリオのエイリアス名と、ユーザーの行動に合わせてMessageを投げれば、インデックスが勝手に増えてシナリオが進んでいくのだ。
- ず: 詳細は省くけど、シナリオ分岐もこの仕組みで実現できるのだ！
- め: なんかややこしい作りになっているわね。このシナリオをModelで直接管理するわけではないのね？
- ず: その通りなのだ。
- ず: なぜならノベルゲームの現在の状態を再現するのに、未来のMessageをすべて知っている必要はないからなのだ。
- ず: というより、ノベルゲームで今後起こりうるすべてのMessageを状態として保持すると、Modelが大きすぎてエンジンが動かなくなる可能性があるのだ……。
- め: あぁそりゃそうですわね。
- ず: あとはアーキテクチャ上の問題で、Modelが未来に起こりうるMessageを知っているのは少し不自然なのだ。
- ず: 状況によってはあるかもしれないけど、基本的にはユーザーのアクションや起こっ『た』ことを抽象化したものがMessageだと思うのだ。
- ず: だからMessageの実体はModelの外側に置いておき、外から順々にtsuzuriへ与えるという形にしたのだ。
- め: なるほど。使ってみないとわからないところもあるけど、よく考えられているわね。
- ず: でもめたん。真に注目すべきはそこではないのだ。
- め: えどういうこと？
- ず: 確かにMessageは定数で管理しているのだ。
- ず: でも、定数で管理できるとはどういうことなのだ？
- め: え？　定数は定数だと思うけど……。
- ず: 定数で管理できるということは、プログラムの中でシナリオを作れるということなのだ！
- め: ……はい？
- 画: シナリオ管理のソースコードを削除
- 画: KAGタグの例を表示
- ず: ノベルゲームエンジンでは、そのエンジン独自のスクリプトを使ってシナリオを構築することがあるのだ。
- ず: 例えば、ノベルゲームエンジンではティラノスクリプトが有名だと思うけど、あちらはノベルゲームの構築に独自のスクリプト言語を使うことになるのだ。
- ず: ただ、タグの仕様上うまく表現できないことが出てきたりすると、JavaScriptとかCSSをいじることになったり、プラグインを突っ込んだりすることもあるのだ。
- め: あぁ、スクリプトで完結できないケースがあるのね。
- ず: ゲームエンジンって基本的に複雑だから、その内部で提供するAPIまで把握するほどの学習コストは、非ゲームエンジニアとしては正直腰が重いのだ。
- ず: あとは単純に情報量が少ないから、調べても欲しい情報が出てこないことがあるし、情報が少ないということは、生成AIのメリットも活かしにくいのだ。
- め: そういう現代的な事情もあるのね。
- 画: KAGタグの例を削除
- め: でもこだわろうとすると、一定は仕方ないんじゃないかしら。
- SE: 荘厳な雰囲気
- ず: いや、僕は傲慢だからそれはいやなのだ！
- め: 自分で傲慢って言って悲しくない？
- ず: だから作ってしまえばいいのだ！
- ず: できるだけ学習コストが低く、最低限のAPIで、TypeScriptという強力なバックグラウンドを持つ、エンジニアにやさしいゲームエンジンを作ってしまえばいいのだ！
- め: 万人のためのノベルゲームエンジンではなく、プログラムを書ける人に特化したノベルゲームエンジンということね。
- ず: 他にもUIライブラリ非依存の実現とか、オーディオ周りの宣言的な管理方法とか、かなり尖ったこともやっているのだ。
- ず: 詳しいことは技術記事が上がっているから、そちらをチェックしてほしいのだ！
- め: ここまで凝っていると面白そうね、今度読んでみるわ。
- め: ところでずんだもん、ゲームエンジンはいいのだけど、肝心のノベルゲームは作っているの？
- ず: ん？　何を言ってるのだ？
- ず: これがノベルゲームなのだ！
- BGM: 解説曲フェードアウト
- ア: ゲーム画面フェードアウト

## おわり

- 各キャラクターのボイスあり
  - 015_metan.mp3 および 023_zundamon.mp3 のみ使用
- キャラクターのセリフはキャラクターに対して吹き出し形式で表示
  - キャラクターのセリフのみ表示
- 画面右下にセーブボタン、ロードボタン、スキップボタン、ログボタン、設定ボタンをアイコンで表示
  - ボタンは半透明で、ホバー時に不透明になる

### 本文

- 画: チュートリアルのゲーム画面
- ア: ゲーム画面をフェードイン
- （フェードインが終わるまでディレイ）
- SE: レベルアップ
- ず: っていうノベルゲームを作ったのだ！
- SE: ツッコミを入れる
- め: ややこしいわ！
- SE: ちゃんちゃん♪3
- ア: ゲーム画面いきなり暗転
- テ: おわり
- （クリック待機）
- テ: クレジット表示
- （クリック待機）
- ア: ゲーム画面フェードアウト
- （タイトル画面へ戻る）

## クレジット

- 音声
  - ずんだもん: VOICEVOX | https://voicevox.hiroshiba.jp/product/zundamon
  - 四国めたん: VOICEVOX | https://voicevox.hiroshiba.jp/product/shikoku_metan
- 立ち絵
  - ずんだもん: 坂本アヒル 様 | https://seiga.nicovideo.jp/seiga/im10788496
  - 四国めたん: 坂本アヒル 様 | https://seiga.nicovideo.jp/seiga/im10791276
- BGM
  - 暴竜ニードルード - MAKOOTO 様 | https://dova-s.jp/bgm/play20645.html
  - 平氏 - 伊藤ケイスケ 様 | https://dova-s.jp/bgm/play22894.html
  - 進軍 - 田中芳典 様 | https://dova-s.jp/bgm/play11346.html
  - 解説しましょ - ichi-h
- SE
  - 効果音ラボ 様 | https://soundeffect-lab.info
- 画像
  - elm.png | http://github.com/elm/elm-lang.org/blob/master/static/assets/logos/elm.png
  - The Elm Architecture | https://guide.elm-lang.org/architecture/
